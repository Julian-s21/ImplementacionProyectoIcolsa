@model icolsaProyecto.Models.HistorialInventarioSaldo

@{
    ViewData["Title"] = "Editar Movimiento de Inventario";

    var userRol = Context.Session.GetString("UsuarioRol");
    Layout = userRol == "Administrativo" || userRol == "Secretario" || userRol == "Empleado"
        ? "~/Views/Shared/_LayoutAdministrativo.cshtml"
        : "~/Views/Shared/_Layout.cshtml";

    var productos = (ViewBag.Productos as IEnumerable<icolsaProyecto.Models.Producto>)?.ToList()
                    ?? new List<icolsaProyecto.Models.Producto>();
}

<div class="container py-5">
    <!-- ENCABEZADO -->
    <div class="bg-white/80 backdrop-blur-md shadow-lg rounded-4 border border-gray-100 p-4 mb-4">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2 class="fw-bold mb-1"
                    style="background: linear-gradient(90deg, #6a11cb, #2575fc);
                           -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                    Editar Movimiento de Inventario
                </h2>
                <p class="text-muted mb-0">Actualiza los datos del movimiento seleccionado.</p>
            </div>
            <a asp-action="Index" class="btn btn-outline-primary rounded-pill fw-semibold shadow-sm">
                <i class="bi bi-arrow-left me-1"></i> Volver
            </a>
        </div>
    </div>

    <!-- FORMULARIO -->
    <div class="bg-white p-5 shadow-lg rounded-4 border-0">
        <form asp-action="Edit"
              method="post"
              autocomplete="off"
              id="formMovimientoEdit"
              novalidate>

            @Html.AntiForgeryToken()
            @Html.HiddenFor(model => model.IDInventarioSaldo)

            <div class="row g-4">

                <!-- Tipo de Movimiento -->
                <div class="col-md-6">
                    <label asp-for="TipoMovimiento" class="form-label fw-semibold">Tipo de Movimiento</label>
                    <select asp-for="TipoMovimiento" class="form-select border-0 shadow-sm rounded-3">
                        <option value="">Seleccione...</option>
                        <option value="Entrada" selected="@(Model.TipoMovimiento == "Entrada")">Entrada</option>
                        <option value="Salida" selected="@(Model.TipoMovimiento == "Salida")">Salida</option>
                    </select>
                    <span class="invalid-feedback d-block small"></span>
                </div>

                <!-- Producto -->
                <div class="col-md-6">
                    <label asp-for="IDProducto" class="form-label fw-semibold">Producto</label>
                    <select asp-for="IDProducto"
                            class="form-select border-0 shadow-sm rounded-3"
                            asp-items="@(new SelectList(productos, nameof(icolsaProyecto.Models.Producto.IDProducto), nameof(icolsaProyecto.Models.Producto.Nombre_Producto), Model.IDProducto))">
                        <option value="">Seleccione un producto</option>
                    </select>
                    <span class="invalid-feedback d-block small"></span>
                </div>

                <!-- Saldo Actual -->
                <div class="col-md-6">
                    <label asp-for="Saldo_Actual" class="form-label fw-semibold">Saldo Actual</label>
                    <input asp-for="Saldo_Actual"
                           type="number"
                           min="0"
                           step="1"
                           class="form-control border-0 shadow-sm rounded-3"
                           placeholder="Ej. 50" />
                    <span class="invalid-feedback d-block small"></span>
                </div>

                <!-- Fecha de Actualización (Solo lectura) -->
                <div class="col-md-6">
                    <label class="form-label fw-semibold">Última actualización</label>
                    <input type="text" readonly class="form-control border-0 shadow-sm rounded-3"
                           value="@(Model.Fecha_Actualizacion?.ToString("g") ?? "—")" />
                    <small class="text-muted">Se actualizará automáticamente al guardar los cambios.</small>
                </div>

                <!-- Información del producto -->
                <div class="col-12">
                    <label class="form-label fw-semibold">Producto seleccionado</label>
                    <div class="p-3 border rounded bg-light">
                        @if (Model.Producto != null)
                        {
                            <div>
                                <strong>@Model.Producto.Nombre_Producto</strong>
                                <div class="text-muted small">Código: @Model.Producto.Codigo_Producto ?? "—"</div>
                            </div>
                        }
                        else
                        {
                            <div class="text-muted small fst-italic">No hay información del producto asociada.</div>
                        }
                    </div>
                </div>
            </div>

            <!-- Resumen de errores -->
            <div id="errorSummaryEdit" class="alert alert-danger mt-4 d-none rounded-4 shadow-sm">
                <h6 class="fw-bold"><i class="bi bi-exclamation-triangle me-2"></i>Errores encontrados:</h6>
                <ul class="mb-0"></ul>
            </div>

            <!-- BOTONES -->
            <div class="text-center mt-5">
                <button type="submit"
                        class="btn px-5 py-2 rounded-pill text-white shadow-sm fw-semibold"
                        style="background: linear-gradient(90deg, #6a11cb, #2575fc);">
                    <i class="bi bi-check-circle me-2"></i>Guardar Cambios
                </button>
                <button type="button" class="btn btn-outline-secondary px-5 py-2 rounded-pill ms-2 shadow-sm"
                        onclick="window.location.href='@Url.Action("Index")'">
                    <i class="bi bi-x-circle me-2"></i>Cancelar
                </button>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
    document.addEventListener("DOMContentLoaded", function () {
        const form = document.getElementById("formMovimientoEdit");
        const errorSummary = document.getElementById("errorSummaryEdit");

        const tipo = form.querySelector("[name='TipoMovimiento']");
        const producto = form.querySelector("[name='IDProducto']");
        const saldo = form.querySelector("[name='Saldo_Actual']");

        function showError(element, message) {
            element.classList.add("is-invalid");
            let fb = element.parentElement.querySelector(".invalid-feedback");
            if (!fb) {
                fb = document.createElement("div");
                fb.classList.add("invalid-feedback", "d-block", "small");
                element.parentElement.appendChild(fb);
            }
            fb.textContent = message;
        }

        function clearError(element) {
            element.classList.remove("is-invalid");
            let fb = element.parentElement.querySelector(".invalid-feedback");
            if (fb) fb.textContent = "";
        }

        form.addEventListener("submit", function (e) {
            let errores = [];

            // Validaciones
            if (!tipo.value) { errores.push("Seleccione el tipo de movimiento."); showError(tipo, "Seleccione el tipo de movimiento."); } else clearError(tipo);
            if (!producto.value) { errores.push("Seleccione un producto."); showError(producto, "Seleccione un producto."); } else clearError(producto);

            const saldoVal = parseInt(saldo.value);
            if (isNaN(saldoVal) || saldoVal < 0) {
                errores.push("Ingrese un saldo actual válido (0 o mayor).");
                showError(saldo, "Ingrese un saldo actual válido (0 o mayor).");
            } else clearError(saldo);

            if (errores.length > 0) {
                e.preventDefault();
                errorSummary.classList.remove("d-none");
                errorSummary.innerHTML = `<strong>Se encontraron los siguientes errores:</strong>
                    <ul class="mb-0 mt-2">${errores.map(x => `<li>${x}</li>`).join("")}</ul>`;
                window.scrollTo({ top: 0, behavior: "smooth" });
                return false;
            } else {
                errorSummary.classList.add("d-none");
            }
        });

        // Mostrar mensaje de éxito (TempData desde controlador)
        @if (TempData["SuccessMessage"] != null)
        {
            <text>
            Swal.fire({
                icon: 'success',
                title: 'Cambios guardados',
                text: '@TempData["SuccessMessage"]',
                timer: 1800,
                showConfirmButton: false
            });
            </text>
        }
    });
    </script>
}
